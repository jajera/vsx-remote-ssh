/**
 * VSX Remote SSH Extension Entry Point
 */
import * as vscode from 'vscode';
import * as path from 'path';
import * as os from 'os';
import { SSHConnectionManagerImpl } from './ssh/connection-manager';
import { RemoteFileSystemProviderImpl } from './ssh/remote-file-system-provider';
import { RemoteTerminalProviderImpl } from './ssh/remote-terminal-provider';
import { RemoteFileCache } from './ssh/remote-file-cache';
import { ConfigurationManager } from './config/configuration-manager';
import { ExtensionHostBridgeImpl } from './vscode/extension-host-bridge';
import { ExtensionHostBridgeExtension } from './vscode/extension-host-bridge-extension';
import { SSHErrorClassifier } from './ssh/error-classifier';
import { ConnectionStateManagerImpl } from './ssh/connection-state-manager';
import { CommandPaletteIntegration } from './vscode/command-palette-integration';
import { WorkspaceContextManager } from './vscode/workspace-context-manager';
import { NotificationService, NotificationLevel } from './vscode/notification-service';
import { PerformanceMonitor } from './ssh/performance-monitor';

/**
 * Main extension class that coordinates all SSH remote functionality
 */
export class SSHRemoteExtension {
  private connectionManager: SSHConnectionManagerImpl;
  private configManager: ConfigurationManager;
  private fileCache: RemoteFileCache;
  private terminalProvider: RemoteTerminalProviderImpl;
  private extensionBridge: ExtensionHostBridgeImpl;
  private extensionBridgeExt: ExtensionHostBridgeExtension;
  private errorClassifier: SSHErrorClassifier;
  private stateManager: ConnectionStateManagerImpl;
  private commandPaletteIntegration: CommandPaletteIntegration;
  private workspaceContextManager: WorkspaceContextManager;
  private notificationService: NotificationService;
  private performanceMonitor: PerformanceMonitor;
  private disposables: vscode.Disposable[] = [];

  constructor(private context: vscode.ExtensionContext) {
    console.log('DEBUG: Extension constructor started');
    
    // Initialize notification service
    this.notificationService = NotificationService.getInstance();
    
    // Initialize configuration manager
    const configDir = path.join(os.homedir(), '.vscode', 'ssh-remote');
    const workspaceRoot = vscode.workspace.workspaceFolders?.[0]?.uri.fsPath;
    this.configManager = new ConfigurationManager(configDir, workspaceRoot);

    // Initialize file cache
    const cacheConfig = {
      maxSize: 100 * 1024 * 1024, // 100MB
      maxAge: 30 * 60 * 1000, // 30 minutes
      cacheDir: path.join(configDir, 'cache'),
      enableCompression: true
    };
    this.fileCache = new RemoteFileCache(cacheConfig);

    // Initialize error classifier
    this.errorClassifier = new SSHErrorClassifier();

    // Initialize connection state manager
    this.stateManager = new ConnectionStateManagerImpl(context);

    // Initialize connection manager with notification service
    this.connectionManager = new SSHConnectionManagerImpl(this.stateManager);

    // Initialize terminal provider
    this.terminalProvider = new RemoteTerminalProviderImpl();

    // Initialize extension bridge
    this.extensionBridge = new ExtensionHostBridgeImpl(
      this.connectionManager,
      this.configManager,
      this.fileCache,
      this.terminalProvider
    );
    
    // Initialize extension bridge extension for extension compatibility
    this.extensionBridgeExt = new ExtensionHostBridgeExtension(this.connectionManager);
    
    // Initialize workspace context manager
    this.workspaceContextManager = new WorkspaceContextManager(
      context,
      this.connectionManager,
      this.configManager
    );
    
    // Initialize command palette integration with workspace context manager
    this.commandPaletteIntegration = new CommandPaletteIntegration(
      this.extensionBridge,
      this.connectionManager,
      this.configManager,
      this.workspaceContextManager
    );
    
    // Initialize performance monitor
    this.performanceMonitor = PerformanceMonitor.getInstance();
    
    // Register a simple test command immediately
    this.disposables.push(
      vscode.commands.registerCommand('remote-ssh.test', () => {
        vscode.window.showInformationMessage('SSH Extension is working!');
        console.log('DEBUG: Test command executed');
      })
    );
    
    console.log('DEBUG: Extension constructor completed');
  }

  /**
   * Initialize the extension
   */
  async activate(): Promise<void> {
    try {
      console.log('DEBUG: Extension activate started');
      
      // Initialize the extension bridge
      await this.extensionBridge.initialize();
      console.log('DEBUG: Extension bridge initialized');
      
      // Initialize the extension bridge extension
      this.extensionBridgeExt.initialize();
      console.log('DEBUG: Extension bridge extension initialized');

      // Register commands using the command palette integration
      this.commandPaletteIntegration.registerCommands();
      console.log('DEBUG: Commands registered');

      // Load cached data
      await this.fileCache.loadFromDisk();
      console.log('DEBUG: Cache loaded');

      // Start performance monitoring
      this.performanceMonitor.startLatencyMonitoring(this.connectionManager);
      this.performanceMonitor.startMemoryMonitoring(this.connectionManager);
      console.log('DEBUG: Performance monitoring started');

      // Auto-connect if configured
      await this.autoConnectIfConfigured();
      console.log('DEBUG: Auto-connect completed');

      console.log('SSH Remote Extension activated successfully');
    } catch (error) {
      console.error('Failed to activate SSH Remote Extension:', error);
      vscode.window.showErrorMessage('Failed to activate SSH Remote Extension');
    }
  }

  /**
   * Deactivate the extension
   */
  async deactivate(): Promise<void> {
    try {
      // Disconnect all connections
      await this.connectionManager.disconnectAll();

      // Dispose of all resources
      this.extensionBridge.dispose();
      this.extensionBridgeExt.dispose();
      this.commandPaletteIntegration.dispose();
      this.workspaceContextManager.dispose();
      this.notificationService.dispose();
      this.performanceMonitor.dispose();
      this.disposables.forEach(d => d.dispose());

      console.log('SSH Remote Extension deactivated');
    } catch (error) {
      console.error('Error during extension deactivation:', error);
    }
  }

  // Command registration is now handled by CommandPaletteIntegration

  /**
   * Auto-connect if configured
   */
  private async autoConnectIfConfigured(): Promise<void> {
    const settings = this.configManager.getWorkspaceSettings();
    if (settings.autoConnectOnOpen) {
      const defaultHost = await this.configManager.getDefaultHost();
      if (defaultHost) {
        try {
          await this.extensionBridge.connectToHost(defaultHost);
        } catch (error) {
          console.warn('Auto-connect failed:', error);
        }
      }
    }
  }

  /**
   * Get the connection manager
   */
  getConnectionManager(): SSHConnectionManagerImpl {
    return this.connectionManager;
  }

  /**
   * Get the configuration manager
   */
  getConfigurationManager(): ConfigurationManager {
    return this.configManager;
  }

  /**
   * Get the file cache
   */
  getFileCache(): RemoteFileCache {
    return this.fileCache;
  }

  /**
   * Get the terminal provider
   */
  getTerminalProvider(): RemoteTerminalProviderImpl {
    return this.terminalProvider;
  }

  /**
   * Get the extension bridge
   */
  getExtensionBridge(): ExtensionHostBridgeImpl {
    return this.extensionBridge;
  }
  
  /**
   * Get the extension bridge extension
   */
  getExtensionBridgeExtension(): ExtensionHostBridgeExtension {
    return this.extensionBridgeExt;
  }
}

// Global extension instance
let extension: SSHRemoteExtension;

/**
 * Extension activation function
 */
export async function activate(context: vscode.ExtensionContext): Promise<void> {
  try {
    console.log('DEBUG: Activating VSX Remote SSH Extension...');
    console.log('DEBUG: Extension context:', context.extension.id);
    console.log('DEBUG: Extension path:', context.extension.extensionPath);
    
    // Create and activate the extension
    extension = new SSHRemoteExtension(context);
    console.log('DEBUG: Extension instance created');
    
    await extension.activate();
    console.log('DEBUG: Extension activate() completed');

    console.log('DEBUG: VSX Remote SSH Extension activated successfully');
    
    // Test command registration immediately
    const testDisposable = vscode.commands.registerCommand('remote-ssh.test-activation', () => {
      vscode.window.showInformationMessage('Extension activation test successful!');
      console.log('DEBUG: Activation test command executed');
    });
    context.subscriptions.push(testDisposable);
    console.log('DEBUG: Test command registered');
    
    // Show welcome message on first install
    const firstInstall = context.globalState.get('remote-ssh.firstInstall');
    if (firstInstall === undefined) {
      vscode.window.showInformationMessage(
        'VSX Remote SSH Extension has been installed. Use the "Connect to Host via SSH" command to get started.',
        'Show Documentation'
      ).then(selection => {
        if (selection === 'Show Documentation') {
          vscode.env.openExternal(vscode.Uri.parse('https://github.com/jajera/vsx-remote-ssh'));
        }
      });
      
      context.globalState.update('remote-ssh.firstInstall', false);
    }
  } catch (error) {
    console.error('DEBUG: Failed to activate VSX Remote SSH Extension:', error);
    vscode.window.showErrorMessage(`Failed to activate VSX Remote SSH Extension: ${error}`);
    throw error;
  }
}

/**
 * Extension deactivation function
 */
export async function deactivate(): Promise<void> {
  try {
    console.log('Deactivating VSX Remote SSH Extension...');
    
    if (extension) {
      await extension.deactivate();
    }
    
    console.log('VSX Remote SSH Extension deactivated successfully');
  } catch (error) {
    console.error('Error during VSX Remote SSH Extension deactivation:', error);
  }
}

/**
 * Get the global extension instance
 */
export function getExtension(): SSHRemoteExtension {
  return extension;
}